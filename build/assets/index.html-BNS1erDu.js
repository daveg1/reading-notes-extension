(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))o(r);new MutationObserver(r=>{for(const s of r)if(s.type==="childList")for(const c of s.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&o(c)}).observe(document,{childList:!0,subtree:!0});function e(r){const s={};return r.integrity&&(s.integrity=r.integrity),r.referrerPolicy&&(s.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?s.credentials="include":r.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function o(r){if(r.ep)return;r.ep=!0;const s=e(r);fetch(r.href,s)}})();async function T(n){const t=await chrome.storage.sync.get(n);return JSON.parse(t[n]??null)}async function d(n,t){await chrome.storage.sync.set({[n]:JSON.stringify(t)})}async function L(){return(await chrome.tabs.query({active:!0}))[0]}async function _(n){return(await chrome.tabs.query({url:n}))[0]}async function E(n){chrome.tabs.update(n,{active:!0})}async function U(n,t){chrome.tabs.update(n,{url:t})}function u(n){return document.querySelector(n)}function f(){H(),m()}function v(n,t){const e=n.sourceTitle.toLocaleLowerCase(),o=t.sourceTitle.toLocaleLowerCase();return e>o?1:e<o?-1:0}function S(n,t){const e=n.sourceTitle.toLocaleLowerCase(),o=t.sourceTitle.toLocaleLowerCase();return e>o?-1:e<o?1:0}const p="notes",y="notes-options";class x{#t;#e;constructor(t,e){this.#t=t,this.#e=e}get options(){return this.#e}updateOption(t,e){this.#e[t]=e,d(y,this.#e)}get notes(){return this.#t.sort(this.#e.isAsc?v:S)}getGroupedNotes(){const t=new Map;for(const e of this.notes)t.has(e.sourceTitle)?t.get(e.sourceTitle)?.push(e):t.set(e.sourceTitle,[e]);return t}async addNote(t){this.#t.push(t),await d(p,this.#t)}async removeNote(t){const e=this.#t.findIndex(r=>r.id===t),o=this.#t.slice();o.splice(e,1),this.#t=o,await d(p,this.#t)}async noteObjectFromUrl(t){const[e,o]=t.split(":~:text=");if(!e||!o)return null;const r=await R(t)??(await L()).title??"";return{id:crypto.randomUUID(),sourceTitle:r,sourceUrl:t,text:decodeURIComponent(o)}}}const M=await T(p)??[],F=await T(y)??{isGrouped:!1,isAsc:!0},i=new x(M,F),b=u("#button-grouped");b.onclick=()=>{i.updateOption("isGrouped",!i.options.isGrouped),f()};function G(){b.textContent=`[${i.options.isGrouped?"X":" "}] grouped`}const N=u("#button-sort");N.onclick=()=>{i.updateOption("isAsc",!i.options.isAsc),f()};function A(){N.classList[i.options.isAsc?"add":"remove"]("asc")}function H(){G(),A()}function m(){const n=u(".note-list");if(n.innerHTML="",!i.notes.length){n.innerHTML="No notes yet.";return}if(i.options.isGrouped){const t=i.getGroupedNotes(),e=new DocumentFragment;for(const[o,r]of t.entries()){const s=P(o),c=w(r,!0);s.lastElementChild?.append(c),e.append(s)}n.append(e)}else{const t=w(i.notes);n.append(t)}}function w(n,t=!1){const e=new DocumentFragment;return n.forEach(o=>{const r=$(o,t);e.append(r)}),e}function P(n){const t=document.createElement("section");t.className="note-list";const e=document.createElement("h3");e.textContent=n;const o=document.createElement("div");return o.className="note-list",t.append(e,o),t}function $(n,t=!1){const e=document.createElement("div");e.className="note",e.id=n.id;const o=document.createElement("a");o.className="note__link",o.href=n.sourceUrl,o.target="_blank",t||(o.innerHTML+=`<span class="note__link__source" title="${n.sourceTitle}">${n.sourceTitle}</span>`),o.innerHTML+=`<span class="note__link__text">${n.text}</span>`,o.onclick=async s=>{s.preventDefault();const c=C(o.href),h=await _(c);h&&await E(h.id);const l=await L();if(D(o.href,l.url??"")){const g=new URL(o.href);await U(l.id,g.href),chrome.scripting.executeScript({target:{tabId:l.id},func:function(O){window.location.hash=O},args:[g.hash]})}else window.open(o.href)};const r=document.createElement("button");return r.className="button note__delete",r.tabIndex=-1,r.textContent="тип",r.onclick=async()=>{await i.removeNote(n.id),m()},e.append(o,r),e}function C(n){const t=new URL(n);return`${t.origin}${t.pathname}*`}function D(n,t){const e=new URL(n),o=new URL(t);return`${e.origin}${e.pathname}`==`${o.origin}${o.pathname}`}async function R(n){const t=await fetch(n).then(r=>r.text()).catch(()=>null);if(!t)return null;const e=t.match(/<title>.*<\/title>/iu);return e?e[0].replace(/<[\/]?title>/giu,"").trim()??null:null}const a=u("#note-form"),I="h-url";a.onsubmit=async n=>{n.preventDefault();const e=new FormData(a).get(I),o=await i.noteObjectFromUrl(e);o&&(i.addNote(o),a.hidden=!0,a.reset(),m())};f();
